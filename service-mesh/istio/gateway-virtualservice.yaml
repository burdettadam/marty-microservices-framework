apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: microservices-framework-gateway
  namespace: microservice-framework
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "framework.local"
    - "*.framework.local"
    - "api.framework.local"
    tls:
      httpsRedirect: true
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "framework.local"
    - "*.framework.local"
    - "api.framework.local"
    tls:
      mode: SIMPLE
      credentialName: framework-tls-secret
  - port:
      number: 9090
      name: grpc
      protocol: GRPC
    hosts:
    - "grpc.framework.local"
    - "*.grpc.framework.local"
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: api-gateway-routes
  namespace: microservice-framework
spec:
  hosts:
  - "api.framework.local"
  - "framework.local"
  gateways:
  - microservices-framework-gateway
  http:
  - match:
    - uri:
        prefix: "/api/v1/health"
    route:
    - destination:
        host: api-gateway
        port:
          number: 8080
    retries:
      attempts: 3
      perTryTimeout: 2s
    timeout: 10s
  - match:
    - uri:
        prefix: "/api/v1/"
    route:
    - destination:
        host: api-gateway
        port:
          number: 8080
    fault:
      delay:
        percentage:
          value: 0.1
        fixedDelay: 5s
    retries:
      attempts: 3
      perTryTimeout: 10s
    timeout: 30s
  - match:
    - uri:
        prefix: "/metrics"
    route:
    - destination:
        host: api-gateway
        port:
          number: 8080
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: template-service-routes
  namespace: microservice-framework
spec:
  hosts:
  - "template.framework.local"
  gateways:
  - microservices-framework-gateway
  http:
  - match:
    - uri:
        prefix: "/template/"
    route:
    - destination:
        host: template-service
        port:
          number: 8080
    retries:
      attempts: 3
      perTryTimeout: 5s
    timeout: 15s
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: grpc-services-routes
  namespace: microservice-framework
spec:
  hosts:
  - "grpc.framework.local"
  gateways:
  - microservices-framework-gateway
  http:
  - match:
    - uri:
        prefix: "/framework."  # gRPC service prefix
    route:
    - destination:
        host: template-service
        port:
          number: 9090
    retries:
      attempts: 3
      perTryTimeout: 10s
    timeout: 30s
---
# Service mesh internal routing
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: internal-service-mesh
  namespace: microservice-framework
spec:
  hosts:
  - api-gateway
  - template-service
  http:
  - match:
    - headers:
        x-request-id:
          regex: ".*"
    route:
    - destination:
        host: api-gateway
      weight: 100
    fault:
      abort:
        percentage:
          value: 0.1
        httpStatus: 500
  - route:
    - destination:
        host: template-service
      weight: 100
---
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: external-kafka
  namespace: microservice-framework
spec:
  hosts:
  - kafka.observability.svc.cluster.local
  ports:
  - number: 9092
    name: kafka
    protocol: TCP
  - number: 9093
    name: kafka-ssl
    protocol: TCP
  location: MESH_EXTERNAL
  resolution: DNS
