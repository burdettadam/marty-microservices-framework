# Fluent Bit Configuration for Marty Microservices Framework
# High-performance log processor and forwarder

[SERVICE]
    # Global settings
    Flush         5
    Daemon        off
    Log_Level     info
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    Health_Check  On
    Parsers_File  /fluent-bit/etc/parsers.conf

    # Storage settings
    storage.path             /tmp/flb-storage/
    storage.sync             normal
    storage.checksum         off
    storage.backlog.mem_limit 50M

# Docker container logs input
[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Tag               docker.*
    Refresh_Interval  5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    DB                /tmp/flb_docker.db

# Kubernetes logs input
[INPUT]
    Name              tail
    Path              /var/log/containers/*.log
    Parser            docker
    Tag               kube.*
    Refresh_Interval  5
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    DB                /tmp/flb_kube.db

# System logs input
[INPUT]
    Name              systemd
    Tag               systemd.*
    Systemd_Filter    _SYSTEMD_UNIT=docker.service
    Systemd_Filter    _SYSTEMD_UNIT=kubelet.service
    DB                /tmp/flb_systemd.db

# Application logs via forward protocol
[INPUT]
    Name   forward
    Listen 0.0.0.0
    Port   24224
    Tag    app.*

# HTTP input for webhook logs
[INPUT]
    Name   http
    Listen 0.0.0.0
    Port   9880
    Tag    webhook.*

# Filter: Kubernetes metadata enrichment
[FILTER]
    Name                kubernetes
    Match               kube.*
    Kube_URL            https://kubernetes.default.svc:443
    Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
    Kube_Tag_Prefix     kube.var.log.containers.
    Merge_Log           On
    Merge_Log_Key       log_processed
    K8S-Logging.Parser  On
    K8S-Logging.Exclude Off
    Annotations         Off
    Labels              On

# Filter: Parse JSON logs
[FILTER]
    Name         parser
    Match        *
    Key_Name     log
    Parser       json
    Reserve_Data On

# Filter: Add common fields
[FILTER]
    Name         modify
    Match        *
    Add          environment ${ENVIRONMENT}
    Add          cluster production
    Add          processed_by fluent-bit

# Filter: Extract service name from container name
[FILTER]
    Name         lua
    Match        docker.*
    Script       /fluent-bit/scripts/extract_service.lua
    Call         extract_service_name

# Filter: Enhance with trace context
[FILTER]
    Name         lua
    Match        *
    Script       /fluent-bit/scripts/trace_context.lua
    Call         enhance_trace_context

# Filter: Performance classification
[FILTER]
    Name         lua
    Match        *
    Script       /fluent-bit/scripts/performance.lua
    Call         classify_performance

# Filter: Security event detection
[FILTER]
    Name         grep
    Match        *
    Regex        log (?i)(authentication|authorization|security|login|logout|access denied|unauthorized)
    Add          category security

# Filter: Error detection
[FILTER]
    Name         grep
    Match        *
    Regex        level (ERROR|CRITICAL|FATAL)
    Add          category error

# Filter: Rate limiting to prevent log flooding
[FILTER]
    Name         throttle
    Match        *
    Rate         1000
    Window       60
    Print_Status true

# Output: Elasticsearch (primary)
[OUTPUT]
    Name            es
    Match           *
    Host            ${ELASTICSEARCH_HOST}
    Port            ${ELASTICSEARCH_PORT}
    Index           marty-logs
    Type            _doc
    Time_Key        @timestamp
    Time_Key_Format %Y-%m-%dT%H:%M:%S.%L%z
    Logstash_Format On
    Logstash_Prefix marty-logs
    Logstash_DateFormat %Y.%m.%d
    Include_Tag_Key On
    Tag_Key         flb_tag
    HTTP_User       ${ES_USER}
    HTTP_Passwd     ${ES_PASSWORD}
    Retry_Limit     5
    Replace_Dots    On

    # Buffer settings
    Buffer_Size     4MB

    # TLS settings
    tls             Off
    tls.verify      Off

# Output: Error logs to separate index
[OUTPUT]
    Name            es
    Match           *error*
    Host            ${ELASTICSEARCH_HOST}
    Port            ${ELASTICSEARCH_PORT}
    Index           marty-errors
    Type            _doc
    Time_Key        @timestamp
    Logstash_Format On
    Logstash_Prefix marty-errors
    Logstash_DateFormat %Y.%m.%d
    Include_Tag_Key On

# Output: Security logs to separate index
[OUTPUT]
    Name            es
    Match_Regex     .*security.*
    Host            ${ELASTICSEARCH_HOST}
    Port            ${ELASTICSEARCH_PORT}
    Index           marty-security
    Type            _doc
    Time_Key        @timestamp
    Logstash_Format On
    Logstash_Prefix marty-security
    Logstash_DateFormat %Y.%m.%d

# Output: Forward to Logstash for complex processing
[OUTPUT]
    Name        forward
    Match       *complex*
    Host        logstash
    Port        24224
    Require_ack_response true

# Output: Prometheus metrics
[OUTPUT]
    Name        prometheus_exporter
    Match       *
    Host        0.0.0.0
    Port        2021

# Output: Debug (uncomment for troubleshooting)
# [OUTPUT]
#     Name   stdout
#     Match  *
#     Format json_lines
