"""
{{service_description}}

This is a FastAPI service generated with enterprise infrastructure:
- OpenTelemetry distributed tracing
- Comprehensive health monitoring and metrics
- Repository pattern for data access
- Event-driven architecture
- Structured configuration management
"""

import uvicorn
from contextlib import asynccontextmanager
from fastapi import FastAPI

from src.framework.config import BaseServiceConfig
from src.framework.observability import init_tracing, auto_instrument, instrument_fastapi
from src.framework.observability.monitoring import ServiceMonitor
{% if use_database %}
from src.framework.database import DatabaseManager
from src.framework.events import TransactionalOutboxEventBus
{% endif %}

from .api.routes import router
from .core.middleware import setup_middleware
from .core.error_handlers import setup_error_handlers


class {{service_name|title}}Config(BaseServiceConfig):
    """Configuration for {{service_name}} service."""

    service_name: str = "{{service_name}}"
    host: str = "0.0.0.0"
    port: int = {{http_port}}
    debug: bool = False
    docs_enabled: bool = True

    {% if use_database %}
    # Database configuration
    database_url: str = "postgresql+asyncpg://user:password@localhost/{{service_name}}_db"
    {% endif %}


# Global references
config = {{service_name|title}}Config()
monitor: ServiceMonitor = None
{% if use_database %}
db_manager: DatabaseManager = None
event_bus: TransactionalOutboxEventBus = None
{% endif %}


@asynccontextmanager
async def lifespan(app: FastAPI):
    """Manage application lifespan with proper startup and shutdown."""
    global monitor{% if use_database %}, db_manager, event_bus{% endif %}

    # Startup
    print(f"Starting {config.service_name} with enterprise infrastructure...")

    # Initialize observability
    init_tracing(service_name=config.service_name)
    auto_instrument()
    instrument_fastapi()

    {% if use_database %}
    # Initialize database
    db_manager = DatabaseManager(config.database_url)
    await db_manager.create_tables()

    # Initialize event bus
    session_factory = db_manager.get_async_session_factory()
    event_bus = TransactionalOutboxEventBus(session_factory)
    await event_bus.start()

    # Store in app state for access in routes
    app.state.db_manager = db_manager
    app.state.event_bus = event_bus
    {% endif %}

    # Start monitoring
    monitor = ServiceMonitor(config.service_name)
    monitor.start_monitoring()
    app.state.monitor = monitor

    print(f"{config.service_name} started successfully")

    yield

    # Shutdown
    print(f"Shutting down {config.service_name}...")

    if monitor:
        monitor.stop_monitoring()

    {% if use_database %}
    if event_bus:
        await event_bus.stop()

    if db_manager:
        await db_manager.close()
    {% endif %}

    print(f"{config.service_name} shutdown complete")


def create_app() -> FastAPI:
    """
    Create FastAPI application with enterprise infrastructure.

    This sets up:
    - Distributed tracing and observability
    - Health monitoring and metrics
    - Database access with repository pattern
    - Event-driven architecture
    - Comprehensive error handling
    """

    # Initialize FastAPI with enterprise configuration
    app = FastAPI(
        title=config.service_name.replace("_", " ").title(),
        description="{{service_description}}",
        version="1.0.0",
        debug=config.debug,
        docs_url="/docs" if config.docs_enabled else None,
        redoc_url="/redoc" if config.docs_enabled else None,
        lifespan=lifespan,
    )

    # Setup enterprise patterns
    setup_middleware(app, service_config)
    setup_error_handlers(app)

    # Include API routes
    app.include_router(router, prefix="/api/v1")

    # Setup logging using DRY patterns
    config.setup_logging()

    return app


def main() -> None:
    """Run the FastAPI application."""
    app = create_app()
    config = create_{{service_package}}_config()

    # Run with uvicorn using DRY configuration
    uvicorn.run(
        app,
        host=config.host,
        port=config.http_port,
        log_level=getattr(config, 'log_level', 'info').lower(),
        reload=config.debug,
    )


if __name__ == "__main__":
    main()
