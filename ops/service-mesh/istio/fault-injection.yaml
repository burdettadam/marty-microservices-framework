---
# Fault Injection for Chaos Engineering
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: fault-injection-payment
  namespace: microservice-framework
  labels:
    app.kubernetes.io/managed-by: marty-msf
    marty.io/policy-type: fault-injection
    marty.io/chaos-engineering: enabled
spec:
  hosts:
  - payment-service.microservice-framework.svc.cluster.local
  http:
  # Inject 5% of requests with 5s delay for latency testing
  - match:
    - headers:
        x-chaos-enabled:
          exact: "true"
    fault:
      delay:
        percentage:
          value: 5.0
        fixedDelay: 5s
    route:
    - destination:
        host: payment-service.microservice-framework.svc.cluster.local
        subset: v1
  # Inject 1% of requests with HTTP 503 for error handling testing
  - match:
    - headers:
        x-chaos-error:
          exact: "true"
    fault:
      abort:
        percentage:
          value: 1.0
        httpStatus: 503
    route:
    - destination:
        host: payment-service.microservice-framework.svc.cluster.local
        subset: v1
  # Default route
  - route:
    - destination:
        host: payment-service.microservice-framework.svc.cluster.local
        subset: v1
---
# Fault Injection for User Service
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: fault-injection-user
  namespace: microservice-framework
  labels:
    app.kubernetes.io/managed-by: marty-msf
    marty.io/policy-type: fault-injection
spec:
  hosts:
  - user-service.microservice-framework.svc.cluster.local
  http:
  # Simulate network latency for load testing
  - match:
    - headers:
        x-load-test:
          exact: "true"
    fault:
      delay:
        percentage:
          value: 10.0
        fixedDelay: 2s
    route:
    - destination:
        host: user-service.microservice-framework.svc.cluster.local
  # Simulate timeout scenarios
  - match:
    - headers:
        x-timeout-test:
          exact: "true"
    fault:
      delay:
        percentage:
          value: 5.0
        fixedDelay: 15s
    route:
    - destination:
        host: user-service.microservice-framework.svc.cluster.local
  # Default route
  - route:
    - destination:
        host: user-service.microservice-framework.svc.cluster.local
---
# Fault Injection for External API Testing
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: fault-injection-external-api
  namespace: microservice-framework
  labels:
    app.kubernetes.io/managed-by: marty-msf
    marty.io/policy-type: fault-injection
spec:
  hosts:
  - external-api.example.com
  http:
  # Simulate external API failures
  - match:
    - headers:
        x-external-failure-test:
          exact: "true"
    fault:
      abort:
        percentage:
          value: 15.0
        httpStatus: 502
    route:
    - destination:
        host: external-api.example.com
  # Simulate external API slowness
  - match:
    - headers:
        x-external-latency-test:
          exact: "true"
    fault:
      delay:
        percentage:
          value: 20.0
        fixedDelay: 8s
    route:
    - destination:
        host: external-api.example.com
  # Default route
  - route:
    - destination:
        host: external-api.example.com
---
# Environment-Specific Fault Injection (Development)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: dev-fault-injection
  namespace: microservice-framework-dev
  labels:
    app.kubernetes.io/managed-by: marty-msf
    marty.io/environment: development
    marty.io/policy-type: fault-injection
spec:
  hosts:
  - "*.microservice-framework-dev.svc.cluster.local"
  http:
  # Enable higher fault injection rates in dev environment
  - match:
    - headers:
        x-dev-chaos:
          exact: "true"
    fault:
      delay:
        percentage:
          value: 15.0
        fixedDelay: 3s
      abort:
        percentage:
          value: 5.0
        httpStatus: 500
    route:
    - destination:
        host: "*.microservice-framework-dev.svc.cluster.local"
  # Default route
  - route:
    - destination:
        host: "*.microservice-framework-dev.svc.cluster.local"
