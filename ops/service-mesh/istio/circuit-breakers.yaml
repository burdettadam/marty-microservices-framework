---
# Circuit Breaker Policies for Critical Services
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: circuit-breaker-critical
  namespace: microservice-framework
  labels:
    app.kubernetes.io/managed-by: marty-msf
    marty.io/policy-type: circuit-breaker
spec:
  host: "*.microservice-framework.svc.cluster.local"
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 50
        connectTimeout: 10s
        tcpNoDelay: true
      http:
        http1MaxPendingRequests: 20
        http2MaxRequests: 100
        maxRequestsPerConnection: 5
        maxRetries: 3
        consecutiveGatewayErrors: 3
        interval: 30s
        baseEjectionTime: 30s
        maxEjectionPercent: 50
        minHealthPercent: 50
    outlierDetection:
      consecutiveGatewayErrors: 3
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 50
---
# Circuit Breaker for External Dependencies
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: circuit-breaker-external
  namespace: microservice-framework
  labels:
    app.kubernetes.io/managed-by: marty-msf
    marty.io/policy-type: circuit-breaker
spec:
  host: "*.external.com"
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 20
        connectTimeout: 5s
        tcpNoDelay: true
      http:
        http1MaxPendingRequests: 10
        http2MaxRequests: 50
        maxRequestsPerConnection: 2
        maxRetries: 2
    outlierDetection:
      consecutiveGatewayErrors: 2
      consecutive5xxErrors: 3
      interval: 15s
      baseEjectionTime: 60s
      maxEjectionPercent: 70
      minHealthPercent: 30
---
# Service-Specific Circuit Breakers
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: payment-service-circuit-breaker
  namespace: microservice-framework
  labels:
    app.kubernetes.io/managed-by: marty-msf
    marty.io/service: payment-service
spec:
  host: payment-service.microservice-framework.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 30
        connectTimeout: 8s
      http:
        http1MaxPendingRequests: 15
        http2MaxRequests: 75
        maxRequestsPerConnection: 3
        maxRetries: 2
    outlierDetection:
      consecutiveGatewayErrors: 3
      consecutive5xxErrors: 4
      interval: 20s
      baseEjectionTime: 45s
      maxEjectionPercent: 60
      minHealthPercent: 40
  subsets:
  - name: v1
    labels:
      version: v1
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 20
        http:
          maxRetries: 1
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 40
        http:
          maxRetries: 3
---
# Database Connection Circuit Breaker
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: database-circuit-breaker
  namespace: microservice-framework
  labels:
    app.kubernetes.io/managed-by: marty-msf
    marty.io/policy-type: circuit-breaker
spec:
  host: postgresql.database.svc.cluster.local
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 10
        connectTimeout: 15s
        tcpNoDelay: true
      http:
        http1MaxPendingRequests: 5
        maxRequestsPerConnection: 1
        maxRetries: 1
    outlierDetection:
      consecutiveGatewayErrors: 2
      consecutive5xxErrors: 2
      interval: 60s
      baseEjectionTime: 120s
      maxEjectionPercent: 80
      minHealthPercent: 20
