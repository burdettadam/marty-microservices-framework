apiVersion: policy.linkerd.io/v1alpha1
kind: HTTPRoute
metadata:
  name: framework-http-routes
  namespace: microservice-framework
spec:
  parentRefs:
  - name: framework-http-server
    kind: Server
    group: policy.linkerd.io
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: "/api/"
    backendRefs:
    - name: api-gateway
      port: 8080
      weight: 100
    timeouts:
      request: 30s
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: "X-Service-Mesh"
          value: "linkerd"
        - name: "X-Request-Source"
          value: "framework-gateway"
  - matches:
    - path:
        type: PathPrefix
        value: "/template/"
    backendRefs:
    - name: template-service
      port: 8080
      weight: 100
    timeouts:
      request: 15s
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: "X-Service-Mesh"
          value: "linkerd"
        - name: "X-Template-Version"
          value: "v1"
  - matches:
    - path:
        type: PathPrefix
        value: "/health/"
    backendRefs:
    - name: api-gateway
      port: 8080
      weight: 50
    - name: template-service
      port: 8080
      weight: 50
    timeouts:
      request: 5s
  - matches:
    - path:
        type: Exact
        value: "/metrics"
    backendRefs:
    - name: api-gateway
      port: 8080
      weight: 50
    - name: template-service
      port: 8080
      weight: 50
    timeouts:
      request: 10s
---
apiVersion: policy.linkerd.io/v1alpha1
kind: HTTPRoute
metadata:
  name: api-gateway-routes
  namespace: microservice-framework
spec:
  parentRefs:
  - name: api-gateway-server
    kind: Server
    group: policy.linkerd.io
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: "/api/v1/template"
    backendRefs:
    - name: template-service
      port: 8080
      weight: 100
    timeouts:
      request: 30s
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: "X-Forwarded-Service"
          value: "api-gateway"
        - name: "X-API-Version"
          value: "v1"
  - matches:
    - path:
        type: PathPrefix
        value: "/api/v1/health"
    backendRefs:
    - name: api-gateway
      port: 8080
      weight: 100
    timeouts:
      request: 5s
  - matches:
    - path:
        type: PathPrefix
        value: "/api/v1/"
    backendRefs:
    - name: api-gateway
      port: 8080
      weight: 100
    timeouts:
      request: 30s
---
apiVersion: policy.linkerd.io/v1alpha1
kind: HTTPRoute
metadata:
  name: template-service-routes
  namespace: microservice-framework
spec:
  parentRefs:
  - name: template-service-server
    kind: Server
    group: policy.linkerd.io
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: "/template/generate"
    backendRefs:
    - name: template-service
      port: 8080
      weight: 100
    timeouts:
      request: 45s  # Template generation might take longer
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: "X-Template-Action"
          value: "generate"
  - matches:
    - path:
        type: PathPrefix
        value: "/template/validate"
    backendRefs:
    - name: template-service
      port: 8080
      weight: 100
    timeouts:
      request: 15s
    filters:
    - type: RequestHeaderModifier
      requestHeaderModifier:
        add:
        - name: "X-Template-Action"
          value: "validate"
  - matches:
    - path:
        type: PathPrefix
        value: "/template/"
    backendRefs:
    - name: template-service
      port: 8080
      weight: 100
    timeouts:
      request: 30s
---
# Observability routes
apiVersion: policy.linkerd.io/v1alpha1
kind: HTTPRoute
metadata:
  name: observability-routes
  namespace: microservice-framework
spec:
  parentRefs:
  - name: prometheus-server
    kind: Server
    group: policy.linkerd.io
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: "/api/v1/"
    backendRefs:
    - name: prometheus
      port: 9090
      weight: 100
    timeouts:
      request: 30s
  - matches:
    - path:
        type: PathPrefix
        value: "/graph"
    backendRefs:
    - name: prometheus
      port: 9090
      weight: 100
    timeouts:
      request: 30s
---
apiVersion: policy.linkerd.io/v1alpha1
kind: HTTPRoute
metadata:
  name: grafana-routes
  namespace: microservice-framework
spec:
  parentRefs:
  - name: grafana-server
    kind: Server
    group: policy.linkerd.io
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: "/api/"
    backendRefs:
    - name: grafana
      port: 3000
      weight: 100
    timeouts:
      request: 30s
  - matches:
    - path:
        type: PathPrefix
        value: "/d/"
    backendRefs:
    - name: grafana
      port: 3000
      weight: 100
    timeouts:
      request: 30s
