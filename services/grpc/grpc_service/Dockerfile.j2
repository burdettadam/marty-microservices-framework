# Use the shared base image with all DRY patterns
FROM marty-base:latest

# Set service-specific build argument
ARG SERVICE_NAME={{service_package}}

# Copy service-specific code
COPY src/{{service_package}}/ /app/src/{{service_package}}/
COPY src/proto/{{service_package}}_pb2.py /app/src/proto/
COPY src/proto/{{service_package}}_pb2_grpc.py /app/src/proto/

# Copy service main file
COPY src/{{service_package}}/main.py /app/main.py

# Set service-specific environment variables
ENV SERVICE_NAME={{service_name}}
ENV GRPC_PORT={{grpc_port}}

# Expose the gRPC port
EXPOSE {{grpc_port}}

# Health check using the DRY health check patterns
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD grpc_health_probe -addr=localhost:{{grpc_port}} || exit 1

# Run the service using the DRY main pattern
CMD ["python", "main.py"]
