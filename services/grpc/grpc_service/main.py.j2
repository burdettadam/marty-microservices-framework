"""
{{service_description}}

This is a gRPC service generated from the Marty Ultra-DRY service template.
It uses enterprise-grade infrastructure components with unified observability:
- gRPC Service Factory with dependency injection
- Unified OpenTelemetry instrumentation and correlation tracking
- Configuration management with secrets
- Multi-backend caching infrastructure
- Message queues and event streaming
- API Gateway integration
- Comprehensive health monitoring
- Event-driven architecture
- Repository pattern for data access
"""

import asyncio
import logging
import sys
from pathlib import Path

# Ensure we can import from the parent directory
sys.path.append(str(Path(__file__).resolve().parents[3]))

# Phase 1 Infrastructure - Enterprise Base
from src.framework.grpc import UnifiedGrpcServer, ServiceDefinition
from src.framework.observability.monitoring import ServiceMonitor
from src.framework.config import BaseServiceConfig
{% if use_database %}
from src.framework.database import DatabaseManager
from src.framework.events import TransactionalOutboxEventBus
{% endif %}

# Phase 2 Infrastructure - Advanced Enterprise Components
from src.framework.config.manager import ConfigManager, SecretManager
from src.framework.cache.manager import CacheManager
from src.framework.messaging.queue import MessageQueue
from src.framework.messaging.streams import EventStreamManager
from src.framework.gateway.api_gateway import APIGateway

# Unified observability imports
from marty_msf.observability.standard import create_standard_observability
from marty_msf.observability.standard_correlation import (
    StandardCorrelationInterceptor,
    CorrelationContext,
    set_plugin_correlation
)

# Import service implementation
from .service import {{service_class}}Service, {{service_class}}ServiceConfig

logger = logging.getLogger(__name__)


async def create_grpc_server() -> UnifiedGrpcServer:
    """Create and configure the unified gRPC server with Phase 2 infrastructure and unified observability."""

    # Phase 1: Load base configuration
    config = {{service_class}}ServiceConfig()

    # Phase 2: Initialize enterprise configuration management
    config_manager = ConfigManager()
    secret_manager = SecretManager()

    # Load service-specific configuration
    service_config = await config_manager.get_config("{{service_name}}", config)

    # Initialize enhanced unified observability
    observability = create_standard_observability(
        service_name="{{service_name}}",
        service_version="1.0.0",
        service_type="grpc"
    )
    await observability.initialize()
    logger.info("Enhanced unified observability initialized")

    # Phase 2: Initialize caching infrastructure
    cache_manager = CacheManager()
    await cache_manager.initialize()

    # Phase 2: Initialize message queue
    message_queue = MessageQueue()
    await message_queue.initialize()

    # Phase 2: Initialize event streaming
    event_stream_manager = EventStreamManager()
    await event_stream_manager.initialize()

    # Phase 2: Initialize API Gateway
    api_gateway = APIGateway()
    await api_gateway.initialize()

    {% if use_database %}
    # Initialize database
    db_manager = DatabaseManager(service_config.database_url)
    await db_manager.create_tables()

    # Initialize event bus
    session_factory = db_manager.get_async_session_factory()
    event_bus = TransactionalOutboxEventBus(session_factory)
    await event_bus.start()

    {% endif %}
    # Create unified gRPC server with enterprise infrastructure
    server = UnifiedGrpcServer(service_name="{{service_name}}")

    # Create service definition with all Phase 2 components
    def create_servicer():
        return {{service_class}}Service(
            config=service_config,
            config_manager=config_manager,
            secret_manager=secret_manager,
            cache_manager=cache_manager,
            message_queue=message_queue,
            event_stream_manager=event_stream_manager,
            api_gateway=api_gateway,
            {% if use_database %}
            db_manager=db_manager,
            event_bus=event_bus,
            {% endif %}
        )

    # Register service with server
    service_def = ServiceDefinition(
        name="{{service_name}}",
        servicer_factory=create_servicer,
        registration_func=add_{{service_class}}Servicer_to_server,
        health_service_name="{{service_name}}"
    )

    server.register_service(service_def)

    return server
            event_stream_manager=event_stream_manager,
            api_gateway=api_gateway,
            {% if use_database %}
            db_manager=db_manager,
            event_bus=event_bus,
            {% endif %}
        )

    # Register service with Phase 2 infrastructure
    service_def = ServiceDefinition(
        name="{{service_name}}",
        servicer_factory=create_service,
        registration_func=lambda servicer, server: None,  # Auto-registered
        health_service_name="{{service_name}}",
    )

    # Register service with API Gateway for discovery
    await api_gateway.register_service(
        service_name="{{service_name}}",
        service_url=f"grpc://localhost:{service_config.grpc_port}",
        health_check_path="/health",
        metadata={
            "version": "1.0.0",
            "capabilities": ["processing", "status"],
            "phase2_enabled": True,
        }
    )

    return server


async def main() -> None:
    """Run {{service_name}} gRPC service with enterprise infrastructure and unified observability."""

    logger.info("Starting {{service_name}} service with Phase 2 enterprise infrastructure")
    logger.info("All observability features enabled")

    # Create unified gRPC server with Phase 2 components
    server = await create_grpc_server()

    try:
        # Start the server
        await server.start()
        logger.info("{{service_name}} gRPC server started successfully")

        # Wait for server termination
        await server.wait_for_termination()
    except KeyboardInterrupt:
        logger.info("Received shutdown signal")
    finally:
        # Cleanup infrastructure components
        logger.info("Shutting down gRPC server and infrastructure")
        await server.stop()
        logger.info("{{service_name}} service shut down complete")

        # Stop service factory
        await factory.stop()


if __name__ == "__main__":
    asyncio.run(main())
